<html lang="de"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kostenlose Barcode App mit Firestore</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f1f1f1;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background: #2c3e50;
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        button {
            background: #2c3e50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        
        button:hover {
            background: #1a2530;
        }
        
        #barcodeResult {
            text-align: center;
            margin-top: 20px;
        }
        
        #scanner-container {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        #interactive.viewport {
            width: 100%;
            height: 100%;
        }
        
        #result {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        
        .download-btn {
            background: #27ae60;
            margin-top: 10px;
        }
        
        .download-btn:hover {
            background: #219653;
        }
        
        .notice {
            background: #ffeaa7;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            font-size: 14px;
        }
        
        /* Stile für die Tabelle */
        .scanned-items {
            margin-top: 30px;
        }
        
        .scanned-items h2 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .total-row {
            font-weight: bold;
            background-color: #e8f4fc;
        }
        
        .delete-btn {
            background: #e74c3c;
            padding: 5px 10px;
            width: auto;
            font-size: 14px;
        }
        
        .delete-btn:hover {
            background: #c0392b;
        }
        
        .price-input {
            display: flex;
            gap: 10px;
        }
        
        .price-input input {
            flex: 1;
        }
        
        .price-input button {
            width: auto;
        }
        
        .price-display {
            font-size: 18px;
            font-weight: bold;
            margin-top: 10px;
            color: #2c3e50;
        }
        
        .barcode-container {
            position: relative;
            display: inline-block;
        }
        
        .price-overlay {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            color: #2c3e50;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 5px;
        }
        
        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .scan-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .scan-options button {
            width: auto;
            flex: 1;
        }
        
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .quantity-control button {
            width: 40px;
            font-size: 18px;
        }
        
        .quantity-control input {
            width: 60px;
            text-align: center;
        }
        
        .manual-input-section {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        
        .manual-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .manual-input-row input {
            flex: 1;
        }
        
        .manual-input-row button {
            width: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Kostenlose Barcode App mit Firestore</h1>
            <p>Generieren und scannen Sie Barcodes mit Cloud-Speicherung</p>
        </header>
        
        <div class="tabs">
            <div class="tab" data-tab="generate">Barcode generieren</div>
            <div class="tab active" data-tab="scan">Barcode scannen</div>
        </div>
        
        <div class="tab-content" id="generateTab">
            <div class="form-group">
                <label for="barcodeType">Barcode-Typ:</label>
                <select id="barcodeType">
                    <option value="CODE128">CODE128</option>
                    <option value="EAN13">EAN13</option>
                    <option value="EAN8">EAN8</option>
                    <option value="UPC">UPC</option>
                    <option value="CODE39">CODE39</option>
                    <option value="ITF14">ITF14</option>
                    <option value="MSI">MSI</option>
                    <option value="pharmacode">Pharmacode</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="barcodeValue">Inhalt (Barcode-Wert):</label>
                <input type="text" id="barcodeValue" placeholder="Text oder Zahlen eingeben">
            </div>
            
            <div class="form-group">
                <label for="itemPrice">Preis (wird im Barcode angezeigt):</label>
                <input type="number" id="itemPrice" placeholder="0.00" step="0.01" min="0">
            </div>
            
            <div class="form-group">
                <label for="itemName">Artikelname:</label>
                <input type="text" id="itemName" placeholder="Name des Artikels" required="">
            </div>
            
            <button id="generateBtn">Barcode generieren und in Firestore speichern</button>
            
            <div id="barcodeResult">
                <div class="barcode-container">
                    <svg id="barcode"></svg>
                    <div class="price-overlay" id="priceOverlay" style="display: none;"></div>
                </div>
                <div class="price-display" id="priceDisplay"></div>
                <button class="download-btn" id="downloadBtn" style="display:none;">Barcode herunterladen</button>
                <div id="statusMessage" class="status-message" style="display: none;"></div>
            </div>
        </div>
        
        <div class="tab-content active" id="scanTab">
            <div id="scanner-container">
                <div id="interactive" class="viewport"><video autoplay="true" preload="auto" src="" muted="true" playsinline="true"></video><canvas class="drawingBuffer" width="640" height="480"></canvas><br clear="all"></div>
            </div>
            <button id="startScanBtn" style="display: block;">Scan starten</button>
            <button id="stopScanBtn" style="display: none;">Scan stoppen</button>
            
            <div id="result"><p>Gescannter Code: <strong>40267654</strong></p><p>Artikel: <strong>uhu_stick</strong></p><p>Preis: <strong>5.00 €</strong></p></div>
            
            <div id="scannedItemOptions" style="display: block;">
                <div class="quantity-control">
                    <label for="itemQuantity">Anzahl:</label>
                    <button id="decreaseQuantity">-</button>
                    <input type="number" id="itemQuantity" value="1" min="1" max="99">
                    <button id="increaseQuantity">+</button>
                </div>
                
                <div class="scan-options">
                    <button id="addItemBtn">Artikel hinzufügen</button>
                    <button id="skipItemBtn">Überspringen</button>
                </div>
            </div>
            
            <!-- Neuer Abschnitt für manuelle Code-Eingabe -->
            <div class="manual-input-section">
                <h3>Code manuell eingeben</h3>
                <div class="manual-input-row">
                    <input type="text" id="manualCodeInput" placeholder="Barcode manuell eingeben">
                    <button id="manualCodeBtn">Code überprüfen</button>
                </div>
            </div>
            
            <div class="scanned-items">
                <h2>Gescannte Artikel</h2>
                <table id="scannedItemsTable">
                    <thead>
                        <tr>
                            <th>Artikelname</th>
                            <th>Preis</th>
                            <th>Anzahl</th>
                            <th>Gesamt</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody id="scannedItemsBody"></tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="3">Gesamtsumme:</td>
                            <td id="totalPrice">0.00 €</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <div class="notice">
            <p><strong>Hinweis:</strong> Diese App speichert Daten in Firestore. Sie können denselben Artikel mehrmals scannen, aber nicht in einem Scan-Vorgang.</p>
        </div>
    </div>

    <script>
        // Firebase Konfiguration und Initialisierung
        const firebaseConfig = {
            apiKey: "AIzaSyCzWfkyiB6zrROZpHsmitlm4MPuVVFT0HA",
            authDomain: "cf-barcode.firebaseapp.com",
            databaseURL: "https://cf-barcode-default-rtdb.firebaseio.com",
            projectId: "cf-barcode",
            storageBucket: "cf-barcode.firebasestorage.app",
            messagingSenderId: "624260290171",
            appId: "1:624260290171:web:d23cf061e28e95cef3f4de",
            measurementId: "G-ZTSVPH1QCF"
        };

        // Firebase initialisieren
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Tab-Funktionalität
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
                
                // Scanner stoppen wenn wir den Tab wechseln
                if(tab.dataset.tab !== 'scan') {
                    stopScanning();
                } else {
                    // Beim Wechsel zum Scan-Tab gescannte Artikel laden
                    loadScannedItems();
                }
            });
        });
        
        // Barcode Generierung
        document.getElementById('generateBtn').addEventListener('click', generateBarcode);
        
        async function generateBarcode() {
            const type = document.getElementById('barcodeType').value;
            const value = document.getElementById('barcodeValue').value.trim();
            const price = document.getElementById('itemPrice').value;
            const name = document.getElementById('itemName').value.trim();
            
            if (!value) {
                alert('Bitte geben Sie einen Text oder Zahlen ein.');
                return;
            }
            
            if (!name) {
                alert('Bitte geben Sie einen Artikelnamen ein.');
                return;
            }
            
            try {
                // Barcode generieren
                JsBarcode("#barcode", value, {
                    format: type,
                    lineColor: "#000000",
                    width: 2,
                    height: 100,
                    displayValue: true
                });
                
                // Preis-Overlay anzeigen, wenn ein Preis angegeben wurde
                const priceOverlay = document.getElementById('priceOverlay');
                const priceDisplay = document.getElementById('priceDisplay');
                
                if (price) {
                    const priceText = `${parseFloat(price).toFixed(2)} €${name ? ' - ' + name : ''}`;
                    priceOverlay.textContent = priceText;
                    priceOverlay.style.display = 'block';
                    priceDisplay.textContent = priceText;
                } else {
                    priceOverlay.style.display = 'none';
                    priceDisplay.textContent = name || '';
                }
                
                document.getElementById('downloadBtn').style.display = 'block';
                
                // In Firestore speichern
                await saveBarcodeToFirestore(value, price, name);
                
            } catch (error) {
                alert('Fehler beim Generieren des Barcodes: ' + error.message);
            }
        }
        
        // Barcode in Firestore speichern
        async function saveBarcodeToFirestore(barcode, price, name) {
            try {
                // Prüfen, ob der Barcode bereits existiert
                const docRef = db.collection('barcodes').doc(barcode);
                const doc = await docRef.get();
                
                if (doc.exists) {
                    // Barcode existiert bereits, Daten aktualisieren
                    await docRef.update({
                        price: price ? parseFloat(price) : null,
                        name: name,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showStatus('Barcode wurde aktualisiert!', 'success');
                } else {
                    // Neuen Barcode hinzufügen
                    await docRef.set({
                        barcode: barcode,
                        price: price ? parseFloat(price) : null,
                        name: name,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showStatus('Barcode wurde in Firestore gespeichert!', 'success');
                }
            } catch (error) {
                console.error('Fehler beim Speichern in Firestore: ', error);
                showStatus('Fehler beim Speichern in Firestore: ' + error.message, 'error');
            }
        }
        
        // Statusmeldung anzeigen
        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = 'status-message ' + type;
            statusElement.style.display = 'block';
            
            // Nach 5 Sekenden ausblenden
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }
        
        // Barcode Download
        document.getElementById('downloadBtn').addEventListener('click', downloadBarcode);
        
        function downloadBarcode() {
            const svg = document.getElementById('barcode');
            const priceOverlay = document.getElementById('priceOverlay');
            const originalDisplay = priceOverlay.style.display;
            
            // Preis-Overlay vorübergehend ausblenden für den Download
            priceOverlay.style.display = 'none';
            
            const svgData = new XMLSerializer().serializeToString(svg);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                // Preis-Text auf das Canvas zeichnen
                if (document.getElementById('itemPrice').value) {
                    ctx.font = "16px Arial";
                    ctx.fillStyle = "#2c3e50";
                    ctx.textAlign = "center";
                    const priceText = document.getElementById('priceOverlay').textContent;
                    ctx.fillText(priceText, canvas.width / 2, canvas.height - 10);
                }
                
                try {
                    const link = document.createElement('a');
                    link.download = 'barcode.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (error) {
                    alert('Download fehlgeschlagen: ' + error.message);
                }
                
                // Preis-Overlay wieder anzeigen
                priceOverlay.style.display = originalDisplay;
            };
            
            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
        }
        
        // Barcode Scanning
        let scanning = false;
        let lastScannedCode = null;
        let lastScannedData = null;
        
        document.getElementById('startScanBtn').addEventListener('click', startScanning);
        document.getElementById('stopScanBtn').addEventListener('click', stopScanning);
        document.getElementById('addItemBtn').addEventListener('click', addScannedItem);
        document.getElementById('skipItemBtn').addEventListener('click', skipScannedItem);
        document.getElementById('increaseQuantity').addEventListener('click', () => {
            const quantityInput = document.getElementById('itemQuantity');
            quantityInput.value = parseInt(quantityInput.value) + 1;
        });
        document.getElementById('decreaseQuantity').addEventListener('click', () => {
            const quantityInput = document.getElementById('itemQuantity');
            if (parseInt(quantityInput.value) > 1) {
                quantityInput.value = parseInt(quantityInput.value) - 1;
            }
        });
        
        // Event-Listener für manuelle Code-Eingabe
        document.getElementById('manualCodeBtn').addEventListener('click', checkManualCode);
        document.getElementById('manualCodeInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                checkManualCode();
            }
        });
        
        // Funktion zur Überprüfung des manuell eingegebenen Codes
        async function checkManualCode() {
            const manualCode = document.getElementById('manualCodeInput').value.trim();
            
            if (!manualCode) {
                alert('Bitte geben Sie einen Code ein.');
                return;
            }
            
            // Scanner stoppen, falls aktiv
            stopScanning();
            
            // Prüfen, ob wir Daten für diesen Barcode in Firestore haben
            try {
                const docRef = db.collection('barcodes').doc(manualCode);
                const doc = await docRef.get();
                
                let resultHTML = `<p>Eingegebener Code: <strong>${manualCode}</strong></p>`;
                
                if (doc.exists) {
                    const data = doc.data();
                    lastScannedCode = manualCode;
                    lastScannedData = data;
                    
                    if (data.name) {
                        resultHTML += `<p>Artikel: <strong>${data.name}</strong></p>`;
                    }
                    if (data.price) {
                        resultHTML += `<p>Preis: <strong>${data.price.toFixed(2)} €</strong></p>`;
                    }
                    
                    document.getElementById('result').innerHTML = resultHTML;
                    
                    // Optionen zum Hinzufügen anzeigen
                    document.getElementById('scannedItemOptions').style.display = 'block';
                    document.getElementById('itemQuantity').value = "1";
                    
                    // Eingabefeld leeren
                    document.getElementById('manualCodeInput').value = '';
                    
                } else {
                    // Keine Daten in Firestore vorhanden
                    document.getElementById('result').innerHTML = resultHTML + 
                        `<p class="error">Keine Daten für diesen Barcode in der Datenbank gefunden.</p>`;
                }
            } catch (error) {
                console.error('Fehler beim Abrufen der Daten: ', error);
                document.getElementById('result').innerHTML = 
                    `<p class="error">Fehler beim Abrufen der Daten: ${error.message}</p>`;
            }
        }
        
        function startScanning() {
            if (scanning) return;
            
            scanning = true;
            document.getElementById('startScanBtn').style.display = 'none';
            document.getElementById('stopScanBtn').style.display = 'block';
            document.getElementById('scannedItemOptions').style.display = 'none';
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        width: 640,
                        height: 480,
                        facingMode: "environment" // Use the back camera
                    }
                },
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "upc_reader",
                        "upc_e_reader"
                    ]
                }
            }, function(err) {
                if (err) {
                    console.error(err);
                    alert("Fehler beim Initialisieren des Scanners: " + err);
                    stopScanning();
                    return;
                }
                
                Quagga.start();
            });
            
            Quagga.onDetected(async function(result) {
                const code = result.codeResult.code;
                lastScannedCode = code;
                
                // Scanner erstmal anhalten
                stopScanning();
                
                // Prüfen, ob wir Daten für diesen Barcode in Firestore haben
                try {
                    const docRef = db.collection('barcodes').doc(code);
                    const doc = await docRef.get();
                    
                    let resultHTML = `<p>Gescannter Code: <strong>${code}</strong></p>`;
                    
                    if (doc.exists) {
                        const data = doc.data();
                        lastScannedData = data;
                        
                        if (data.name) {
                            resultHTML += `<p>Artikel: <strong>${data.name}</strong></p>`;
                        }
                        if (data.price) {
                            resultHTML += `<p>Preis: <strong>${data.price.toFixed(2)} €</strong></p>`;
                        }
                        
                        document.getElementById('result').innerHTML = resultHTML;
                        
                        // Optionen zum Hinzufügen anzeigen
                        document.getElementById('scannedItemOptions').style.display = 'block';
                        document.getElementById('itemQuantity').value = "1";
                        
                    } else {
                        // Keine Daten in Firestore vorhanden
                        document.getElementById('result').innerHTML = resultHTML + 
                            `<p class="error">Keine Daten für diesen Barcode in der Datenbank gefunden.</p>`;
                        
                        // Nach 2 Sekunden wieder scannen
                        setTimeout(startScanning, 2000);
                    }
                } catch (error) {
                    console.error('Fehler beim Abrufen der Daten: ', error);
                    document.getElementById('result').innerHTML = 
                        `<p class="error">Fehler beim Abrufen der Daten: ${error.message}</p>`;
                    
                    // Nach 2 Sekunden wieder scannen
                    setTimeout(startScanning, 2000);
                }
            });
        }
        
        function stopScanning() {
            if (!scanning) return;
            
            Quagga.stop();
            scanning = false;
            document.getElementById('startScanBtn').style.display = 'block';
            document.getElementById('stopScanBtn').style.display = 'none';
        }
        
        function addScannedItem() {
            if (!lastScannedData) return;
            
            const quantity = parseInt(document.getElementById('itemQuantity').value);
            
            // Artikel zur Liste hinzufügen
            addScannedItemToTable(lastScannedCode, lastScannedData.price, lastScannedData.name, quantity);
            
            // Optionen ausblenden
            document.getElementById('scannedItemOptions').style.display = 'none';
            
            // Nach 1 Sekunde wieder scannen
            setTimeout(startScanning, 1000);
        }
        
        function skipScannedItem() {
            // Optionen ausblenden
            document.getElementById('scannedItemOptions').style.display = 'none';
            
            // Sofort wieder scannen
            startScanning();
        }
        
        function addScannedItemToTable(barcode, price, name, quantity = 1) {
            // Gescannte Artikel aus dem Local Storage laden oder leeres Array erstellen
            const scannedItems = JSON.parse(localStorage.getItem('scannedItems')) || [];
            
            // Prüfen, ob der Artikel bereits vorhanden ist
            const existingItemIndex = scannedItems.findIndex(item => item.barcode === barcode);
            
            if (existingItemIndex !== -1) {
                // Artikel existiert bereits - Menge erhöhen
                scannedItems[existingItemIndex].quantity += quantity;
                scannedItems[existingItemIndex].timestamp = new Date().toLocaleString('de-DE');
            } else {
                // Neuen Artikel hinzufügen
                const newItem = {
                    barcode: barcode,
                    name: name,
                    price: price,
                    quantity: quantity,
                    timestamp: new Date().toLocaleString('de-DE')
                };
                
                scannedItems.push(newItem);
            }
            
            // In Local Storage speichern
            localStorage.setItem('scannedItems', JSON.stringify(scannedItems));
            
            // Tabelle aktualisieren
            loadScannedItems();
        }
        
        function loadScannedItems() {
            const scannedItems = JSON.parse(localStorage.getItem('scannedItems')) || [];
            const tableBody = document.getElementById('scannedItemsBody');
            const totalPriceElement = document.getElementById('totalPrice');
            
            // Tabelle leeren
            tableBody.innerHTML = '';
            
            // Gesamtpreis berechnen
            let totalPrice = 0;
            
            // Artikel zur Tabelle hinzufügen
            scannedItems.forEach((item, index) => {
                const row = document.createElement('tr');
                const itemTotal = item.price ? (item.price * item.quantity) : 0;
                
                row.innerHTML = `
                    <td>${item.name || '-'}</td>
                    <td>${item.price ? item.price.toFixed(2) + ' €' : '-'}</td>
                    <td>${item.quantity}</td>
                    <td>${itemTotal.toFixed(2)} €</td>
                    <td>
                        <button class="delete-btn" data-index="${index}">Löschen</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
                if (item.price) totalPrice += itemTotal;
            });
            
            // Gesamtpreis anzeigen
            totalPriceElement.textContent = `${totalPrice.toFixed(2)} €`;
            
            // Event-Listener für Lösch-Buttons hinzufügen
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteScannedItem(index);
                });
            });
        }
        
        function deleteScannedItem(index) {
            const scannedItems = JSON.parse(localStorage.getItem('scannedItems')) || [];
            
            // Artikel entfernen
            scannedItems.splice(index, 1);
            
            // In Local Storage speichern
            localStorage.setItem('scannedItems', JSON.stringify(scannedItems));
            
            // Tabelle aktualisieren
            loadScannedItems();
        }
        
        // Beim Verlassen der Seite Scanner stoppen
        window.addEventListener('beforeunload', stopScanning);
        
        // Beim Laden der Seite gescannte Artikel laden, falls wir im Scan-Tab sind
        if (document.getElementById('scanTab').classList.contains('active')) {
            loadScannedItems();
        }
    </script>
</body></html>
