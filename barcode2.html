<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kostenlose Barcode App mit Firestore</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f1f1f1;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background: #2c3e50;
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        button {
            background: #2c3e50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        
        button:hover {
            background: #1a2530;
        }
        
        #barcodeResult {
            text-align: center;
            margin-top: 20px;
        }
        
        #scanner-container {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        #interactive.viewport {
            width: 100%;
            height: 100%;
        }
        
        #result {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        
        .download-btn {
            background: #27ae60;
            margin-top: 10px;
        }
        
        .download-btn:hover {
            background: #219653;
        }
        
        .notice {
            background: #ffeaa7;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            font-size: 14px;
        }
        
        /* Stile für die Tabelle */
        .scanned-items {
            margin-top: 30px;
        }
        
        .scanned-items h2 {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .total-row {
            font-weight: bold;
            background-color: #e8f4fc;
        }
        
        .delete-btn {
            background: #e74c3c;
            padding: 5px 10px;
            width: auto;
            font-size: 14px;
        }
        
        .delete-btn:hover {
            background: #c0392b;
        }
        
        .price-input {
            display: flex;
            gap: 10px;
        }
        
        .price-input input {
            flex: 1;
        }
        
        .price-input button {
            width: auto;
        }
        
        .price-display {
            font-size: 18px;
            font-weight: bold;
            margin-top: 10px;
            color: #2c3e50;
        }
        
        .barcode-container {
            position: relative;
            display: inline-block;
        }
        
        .price-overlay {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            color: #2c3e50;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 5px;
        }
        
        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .already-scanned {
            background-color: #fff3cd;
            color: #856404;
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Kostenlose Barcode App mit Firestore</h1>
            <p>Generieren und scannen Sie Barcodes mit Cloud-Speicherung</p>
        </header>
        
        <div class="tabs">
            <div class="tab active" data-tab="generate">Barcode generieren</div>
            <div class="tab" data-tab="scan">Barcode scannen</div>
        </div>
        
        <div class="tab-content active" id="generateTab">
            <div class="form-group">
                <label for="barcodeType">Barcode-Typ:</label>
                <select id="barcodeType">
                    <option value="CODE128">CODE128</option>
                    <option value="EAN13">EAN13</option>
                    <option value="EAN8">EAN8</option>
                    <option value="UPC">UPC</option>
                    <option value="CODE39">CODE39</option>
                    <option value="ITF14">ITF14</option>
                    <option value="MSI">MSI</option>
                    <option value="pharmacode">Pharmacode</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="barcodeValue">Inhalt (Barcode-Wert):</label>
                <input type="text" id="barcodeValue" placeholder="Text oder Zahlen eingeben">
            </div>
            
            <div class="form-group">
                <label for="itemPrice">Preis (wird im Barcode angezeigt):</label>
                <input type="number" id="itemPrice" placeholder="0.00" step="0.01" min="0">
            </div>
            
            <div class="form-group">
                <label for="itemName">Artikelname:</label>
                <input type="text" id="itemName" placeholder="Name des Artikels" required>
            </div>
            
            <button id="generateBtn">Barcode generieren und in Firestore speichern</button>
            
            <div id="barcodeResult">
                <div class="barcode-container">
                    <svg id="barcode"></svg>
                    <div class="price-overlay" id="priceOverlay" style="display: none;"></div>
                </div>
                <div class="price-display" id="priceDisplay"></div>
                <button class="download-btn" id="downloadBtn" style="display:none;">Barcode herunterladen</button>
                <div id="statusMessage" class="status-message" style="display: none;"></div>
            </div>
        </div>
        
        <div class="tab-content" id="scanTab">
            <div id="scanner-container">
                <div id="interactive" class="viewport"></div>
            </div>
            <button id="startScanBtn">Scan starten</button>
            <button id="stopScanBtn" style="display:none;">Scan stoppen</button>
            
            <div id="result">
                <p>Scannen Sie einen Barcode, um das Ergebnis hier zu sehen.</p>
            </div>
            
            <div id="alreadyScannedMessage" class="already-scanned" style="display: none;">
                Dieser Artikel wurde bereits gescannt und ist in der Liste.
            </div>
            
            <div class="scanned-items">
                <h2>Gescannte Artikel (Einmalige Erfassung)</h2>
                <table id="scannedItemsTable">
                    <thead>
                        <tr>
                            <th>Barcode</th>
                            <th>Artikelname</th>
                            <th>Preis</th>
                            <th>Zeitpunkt</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody id="scannedItemsBody">
                        <!-- Hier werden die gescannten Artikel eingefügt -->
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="2">Gesamtsumme:</td>
                            <td id="totalPrice">0.00 €</td>
                            <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
        
        <div class="notice">
            <p><strong>Hinweis:</strong> Diese App speichert Daten in Firestore. Jeder Artikel wird nur einmal in der Liste angezeigt, auch bei mehrmaligem Scannen.</p>
        </div>
    </div>

    <script>
        // Firebase Konfiguration und Initialisierung
        const firebaseConfig = {
            apiKey: "AIzaSyCzWfkyiB6zrROZpHsmitlm4MPuVVFT0HA",
            authDomain: "cf-barcode.firebaseapp.com",
            databaseURL: "https://cf-barcode-default-rtdb.firebaseio.com",
            projectId: "cf-barcode",
            storageBucket: "cf-barcode.firebasestorage.app",
            messagingSenderId: "624260290171",
            appId: "1:624260290171:web:d23cf061e28e95cef3f4de",
            measurementId: "G-ZTSVPH1QCF"
        };

        // Firebase initialisieren
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Tab-Funktionalität
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
                
                // Scanner stoppen wenn wir den Tab wechseln
                if(tab.dataset.tab !== 'scan') {
                    stopScanning();
                } else {
                    // Beim Wechsel zum Scan-Tab gescannte Artikel laden
                    loadScannedItems();
                }
            });
        });
        
        // Barcode Generierung
        document.getElementById('generateBtn').addEventListener('click', generateBarcode);
        
        async function generateBarcode() {
            const type = document.getElementById('barcodeType').value;
            const value = document.getElementById('barcodeValue').value.trim();
            const price = document.getElementById('itemPrice').value;
            const name = document.getElementById('itemName').value.trim();
            
            if (!value) {
                alert('Bitte geben Sie einen Text oder Zahlen ein.');
                return;
            }
            
            if (!name) {
                alert('Bitte geben Sie einen Artikelnamen ein.');
                return;
            }
            
            try {
                // Barcode generieren
                JsBarcode("#barcode", value, {
                    format: type,
                    lineColor: "#000000",
                    width: 2,
                    height: 100,
                    displayValue: true
                });
                
                // Preis-Overlay anzeigen, wenn ein Preis angegeben wurde
                const priceOverlay = document.getElementById('priceOverlay');
                const priceDisplay = document.getElementById('priceDisplay');
                
                if (price) {
                    const priceText = `${parseFloat(price).toFixed(2)} €${name ? ' - ' + name : ''}`;
                    priceOverlay.textContent = priceText;
                    priceOverlay.style.display = 'block';
                    priceDisplay.textContent = priceText;
                } else {
                    priceOverlay.style.display = 'none';
                    priceDisplay.textContent = name || '';
                }
                
                document.getElementById('downloadBtn').style.display = 'block';
                
                // In Firestore speichern
                await saveBarcodeToFirestore(value, price, name);
                
            } catch (error) {
                alert('Fehler beim Generieren des Barcodes: ' + error.message);
            }
        }
        
        // Barcode in Firestore speichern
        async function saveBarcodeToFirestore(barcode, price, name) {
            try {
                // Prüfen, ob der Barcode bereits existiert
                const docRef = db.collection('barcodes').doc(barcode);
                const doc = await docRef.get();
                
                if (doc.exists) {
                    // Barcode existiert bereits, Daten aktualisieren
                    await docRef.update({
                        price: price ? parseFloat(price) : null,
                        name: name,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showStatus('Barcode wurde aktualisiert!', 'success');
                } else {
                    // Neuen Barcode hinzufügen
                    await docRef.set({
                        barcode: barcode,
                        price: price ? parseFloat(price) : null,
                        name: name,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showStatus('Barcode wurde in Firestore gespeichert!', 'success');
                }
            } catch (error) {
                console.error('Fehler beim Speichern in Firestore: ', error);
                showStatus('Fehler beim Speichern in Firestore: ' + error.message, 'error');
            }
        }
        
        // Statusmeldung anzeigen
        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = 'status-message ' + type;
            statusElement.style.display = 'block';
            
            // Nach 5 Sekenden ausblenden
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }
        
        // Barcode Download
        document.getElementById('downloadBtn').addEventListener('click', downloadBarcode);
        
        function downloadBarcode() {
            const svg = document.getElementById('barcode');
            const priceOverlay = document.getElementById('priceOverlay');
            const originalDisplay = priceOverlay.style.display;
            
            // Preis-Overlay vorübergehend ausblenden für den Download
            priceOverlay.style.display = 'none';
            
            const svgData = new XMLSerializer().serializeToString(svg);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                // Preis-Text auf das Canvas zeichnen
                if (document.getElementById('itemPrice').value) {
                    ctx.font = "16px Arial";
                    ctx.fillStyle = "#2c3e50";
                    ctx.textAlign = "center";
                    const priceText = document.getElementById('priceOverlay').textContent;
                    ctx.fillText(priceText, canvas.width / 2, canvas.height - 10);
                }
                
                try {
                    const link = document.createElement('a');
                    link.download = 'barcode.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (error) {
                    alert('Download fehlgeschlagen: ' + error.message);
                }
                
                // Preis-Overlay wieder anzeigen
                priceOverlay.style.display = originalDisplay;
            };
            
            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
        }
        
        // Barcode Scanning
        let scanning = false;
        let lastScannedCode = null;
        
        document.getElementById('startScanBtn').addEventListener('click', startScanning);
        document.getElementById('stopScanBtn').addEventListener('click', stopScanning);
        
        function startScanning() {
            if (scanning) return;
            
            scanning = true;
            document.getElementById('startScanBtn').style.display = 'none';
            document.getElementById('stopScanBtn').style.display = 'block';
            document.getElementById('alreadyScannedMessage').style.display = 'none';
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        width: 640,
                        height: 480,
                        facingMode: "environment" // Use the back camera
                    }
                },
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "upc_reader",
                        "upc_e_reader"
                    ]
                }
            }, function(err) {
                if (err) {
                    console.error(err);
                    alert("Fehler beim Initialisieren des Scanners: " + err);
                    stopScanning();
                    return;
                }
                
                Quagga.start();
            });
            
            Quagga.onDetected(async function(result) {
                const code = result.codeResult.code;
                lastScannedCode = code;
                
                // Prüfen, ob wir Daten für diesen Barcode in Firestore haben
                try {
                    const docRef = db.collection('barcodes').doc(code);
                    const doc = await docRef.get();
                    
                    let resultHTML = `<p>Gescannter Code: <strong>${code}</strong></p>`;
                    
                    if (doc.exists) {
                        const data = doc.data();
                        
                        if (data.name) {
                            resultHTML += `<p>Artikel: <strong>${data.name}</strong></p>`;
                        }
                        if (data.price) {
                            resultHTML += `<p>Preis: <strong>${data.price.toFixed(2)} €</strong></p>`;
                        }
                        
                        document.getElementById('result').innerHTML = resultHTML;
                        
                        // Prüfen, ob der Artikel bereits in der Liste ist
                        const scannedItems = JSON.parse(localStorage.getItem('scannedItems')) || [];
                        const isAlreadyScanned = scannedItems.some(item => item.barcode === code);
                        
                        if (isAlreadyScanned) {
                            // Artikel wurde bereits gescannt
                            document.getElementById('alreadyScannedMessage').style.display = 'block';
                            
                            // Kurz pausieren nach erfolgreichem Scan
                            stopScanning();
                            setTimeout(startScanning, 2000);
                        } else {
                            // Artikel zur Liste hinzufügen
                            addScannedItemToTable(code, data.price, data.name);
                            
                            // Kurz pausieren nach erfolgreichem Scan
                            stopScanning();
                            setTimeout(startScanning, 2000);
                        }
                    } else {
                        // Keine Daten in Firestore vorhanden
                        document.getElementById('result').innerHTML = resultHTML + 
                            `<p class="error">Keine Daten für diesen Barcode in der Datenbank gefunden.</p>`;
                        
                        // Kurz pausieren nach Scan
                        stopScanning();
                        setTimeout(startScanning, 2000);
                    }
                } catch (error) {
                    console.error('Fehler beim Abrufen der Daten: ', error);
                    document.getElementById('result').innerHTML = 
                        `<p class="error">Fehler beim Abrufen der Daten: ${error.message}</p>`;
                }
            });
        }
        
        function stopScanning() {
            if (!scanning) return;
            
            Quagga.stop();
            scanning = false;
            document.getElementById('startScanBtn').style.display = 'block';
            document.getElementById('stopScanBtn').style.display = 'none';
        }
        
        function addScannedItemToTable(barcode, price, name) {
            // Gescannte Artikel aus dem Local Storage laden oder leeres Array erstellen
            const scannedItems = JSON.parse(localStorage.getItem('scannedItems')) || [];
            
            // Prüfen, ob der Artikel bereits vorhanden ist
            const isAlreadyScanned = scannedItems.some(item => item.barcode === barcode);
            
            if (isAlreadyScanned) {
                // Artikel existiert bereits - nicht erneut hinzufügen
                document.getElementById('alreadyScannedMessage').style.display = 'block';
                return;
            }
            
            // Neuen Artikel hinzufügen
            const newItem = {
                barcode: barcode,
                name: name,
                price: price,
                timestamp: new Date().toLocaleString('de-DE')
            };
            
            scannedItems.push(newItem);
            
            // In Local Storage speichern
            localStorage.setItem('scannedItems', JSON.stringify(scannedItems));
            
            // Tabelle aktualisieren
            loadScannedItems();
        }
        
        function loadScannedItems() {
            const scannedItems = JSON.parse(localStorage.getItem('scannedItems')) || [];
            const tableBody = document.getElementById('scannedItemsBody');
            const totalPriceElement = document.getElementById('totalPrice');
            
            // Tabelle leeren
            tableBody.innerHTML = '';
            
            // Gesamtpreis berechnen
            let totalPrice = 0;
            
            // Artikel zur Tabelle hinzufügen
            scannedItems.forEach((item, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${item.barcode}</td>
                    <td>${item.name || '-'}</td>
                    <td>${item.price ? item.price.toFixed(2) + ' €' : '-'}</td>
                    <td>${item.timestamp}</td>
                    <td>
                        <button class="delete-btn" data-index="${index}">Löschen</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
                if (item.price) totalPrice += item.price;
            });
            
            // Gesamtpreis anzeigen
            totalPriceElement.textContent = `${totalPrice.toFixed(2)} €`;
            
            // Event-Listener für Lösch-Buttons hinzufügen
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deleteScannedItem(index);
                });
            });
        }
        
        function deleteScannedItem(index) {
            const scannedItems = JSON.parse(localStorage.getItem('scannedItems')) || [];
            
            // Artikel entfernen
            scannedItems.splice(index, 1);
            
            // In Local Storage speichern
            localStorage.setItem('scannedItems', JSON.stringify(scannedItems));
            
            // Tabelle aktualisieren
            loadScannedItems();
        }
        
        // Beim Verlassen der Seite Scanner stoppen
        window.addEventListener('beforeunload', stopScanning);
        
        // Beim Laden der Seite gescannte Artikel laden, falls wir im Scan-Tab sind
        if (document.getElementById('scanTab').classList.contains('active')) {
            loadScannedItems();
        }
    </script>
</body>
</html>
